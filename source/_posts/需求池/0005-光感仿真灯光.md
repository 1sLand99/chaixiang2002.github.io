[Android中的lights小系统](http://huzhengyu.com/2021/01/20/lights-in-android/)

```
Framework
frameworks/base/services/core/java/com/android/server/lights/LightsManager.java
rameworks/base/services/core/java/com/android/server/lights/Light.java
frameworks/base/services/core/java/com/android/server/lights/LightsService.java
Log标签：LightsService
代码生效 mmm framework/base/service

JNI
frameworks/base/services/core/jni/com_android_server_lights_LightsService.cpp
Log标签：LightsService

HAL
原生的路径：hardware/interfaces/light/2.0/default/Light.cpp
MTK路径：vendor/mediatek/proprietary/hardware/liblights/2.0/default/Light.cpp 
Log标签：lights

liblights
vendor/mediatek/proprietary/hardware/liblights/lights.c
Log标签：lights
```

 E LightsService: Light requested not available on this device. 0

### 文件具体分析

---

frameworks/base/services/core/jni/com_android_server_lights_LightsService.cpp:115

在你提供的 `LightsService.cpp` 源码中，这段代码实现了 Android 中灯光控制的 JNI 接口，并与灯光硬件抽象层（HAL）进行交互。以下是代码中主要功能和每个函数的详细讲解：

### 主要功能

1. **JNI 注册**：该文件通过 JNI 提供了 Java 和 C++ 之间的接口，使 Java 层可以调用 C++ 实现的功能。
2. **灯光状态控制**：提供了设置灯光（如背光、LED 灯等）的功能，包括颜色、闪烁模式和亮度等。

### 主要函数及其作用

1. **`validate` 函数**：
   - **作用**：验证输入的灯光参数是否合法。
   - **参数**：
     - `light`：灯光类型（如背光、通知灯等）。
     - `flash`：闪烁模式（如无闪烁、定时闪烁、硬件闪烁）。
     - `brightness`：亮度模式（如用户控制、传感器控制等）。
   - **返回**：返回 `true` 如果所有参数都合法，否则返回 `false` 并在日志中记录错误信息。

2. **`constructState` 函数**：
   - **作用**：根据输入参数构造 `LightState` 对象，表示灯光的状态。
   - **参数**：
     - `colorARGB`：灯光颜色。
     - `flashMode`：闪烁模式。
     - `onMS`：闪烁开启时间。
     - `offMS`：闪烁关闭时间。
     - `brightnessMode`：亮度模式。
   - **返回**：返回构造好的 `LightState` 对象。

3. **`processReturn` 函数**：
   - **作用**：处理 HAL 接口返回的状态。
   - **参数**：
     - `ret`：返回状态。
     - `type`：灯光类型。
     - `state`：灯光状态。
   - **功能**：
     - 根据返回状态输出相应的日志信息。
     - 如果返回状态是 `LIGHT_NOT_SUPPORTED`，则记录 `"Light requested not available on this device"` 的错误信息。

4. **`setLight_native` 函数**：
   - **作用**：设置灯光状态的主要函数。
   - **参数**：
     - `light`、`colorARGB`、`flashMode`、`onMS`、`offMS`、`brightnessMode`：分别表示灯光类型、颜色、闪烁模式、开启和关闭时间、亮度模式。
   - **功能**：
     - 首先检查灯光是否支持（`sLightSupported`）。
     - 验证输入参数的合法性。
     - 调用 HAL 接口设置灯光状态，并处理返回结果。

5. **`register_android_server_LightsService` 函数**：
   - **作用**：注册 JNI 方法，使 Java 层可以调用本文件中的 C++ 函数。
   - **返回**：成功注册返回 0。

### `"Light requested not available on this device"` 的可能原因

当你在设备上调用设置灯光状态的功能时，如果设备不支持请求的灯光类型，`setLight_native` 函数会调用 HAL 接口并返回 `LIGHT_NOT_SUPPORTED`。这时 `processReturn` 函数会记录该错误。

可能的原因包括：

- **硬件不支持**：设备可能没有实现某种灯光功能（例如，某些低端设备可能没有 LED 灯）。
- **驱动问题**：设备的灯光驱动可能未正确配置或未加载，导致无法访问灯光功能。
- **类型错误**：传递给 `setLight_native` 的 `light` 参数可能不对应设备支持的灯光类型。

通过这些信息，你可以更好地理解这个 C++ 文件的实现以及它与 Android 灯光管理的关系。如果你有其他具体问题或需要更深入的解析，请告诉我！